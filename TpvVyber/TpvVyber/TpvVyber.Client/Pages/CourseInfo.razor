@page "/course_info/{CourseId:int}"
@inject ISelectService selectService
@inject PersistentComponentState ApplicationState
@implements IDisposable
@attribute [Authorize]
@inject IUpdateService updateService
@implements IClientUpdateHandler

@if (Course != null)
{
    <MudSimpleTable Dense="true" Hover="true" Bordered="true" Striped="false" Style="overflow-x: auto;">
        <thead>
            <MudTr>
                <MudTh><b aria-label="MudSimpleTable-vlastnost">Vlastnost</b></MudTh>
                <MudTh><b aria-label="MudSimpleTable-hodnota">Hodnota</b></MudTh>
            </MudTr>
        </thead>
        <tbody>
            <MudTr>
                <MudTd aria-label="MudSimpleTable-id">Id</MudTd>
                <MudTd aria-label="MudSimpleTable-id-val">@Course.Id</MudTd>
            </MudTr>
            <MudTr>
                <MudTd aria-label="MudSimpleTable-jmeno">Jméno</MudTd>
                <MudTd aria-label="MudSimpleTable-jmeno-val">@Course.Name</MudTd>
            </MudTr>
            <MudTr>
                <MudTd aria-label="MudSimpleTable-popis">Popis</MudTd>
                <MudTd aria-label="MudSimpleTable-popis-val">@Course.Description</MudTd>
            </MudTr>
            <MudTr>
                <MudTd aria-label="MudSimpleTable-Pdf">Pdf Url</MudTd>
                <MudTd>
                    <MudLink aria-label="MudSimpleTable-Pdf-val" Href="@Course.PdfUrl">@Course.PdfUrl</MudLink>
                </MudTd>
            </MudTr>
            <MudTr>
                <MudTd aria-label="MudSimpleTable-ForClasses">Pro třídy</MudTd>
                <MudTd aria-label="MudSimpleTable-ForClasses-val">@string.Join(", ", Course.ForClasses.Split(";"))</MudTd>
            </MudTr>
            <MudTr>
                <MudTd aria-label="MudSimpleTable-PriceMin">Cena Min. Obsazenost</MudTd>
                <MudTd aria-label="MudSimpleTable-PriceMin-val">@Course.MinPrice</MudTd>
            </MudTr>
            <MudTr>
                <MudTd aria-label="MudSimpleTable-PriceMax">Cena Max. Obsazenost</MudTd>
                <MudTd aria-label="MudSimpleTable-PriceMax-val">@Course.MaxPrice</MudTd>
            </MudTr>
            <MudTr>
                <MudTd aria-label="MudSimpleTable-Capa">Kapacita</MudTd>
                <MudTd aria-label="MudSimpleTable-Capa-val">@Course.Capacity</MudTd>
            </MudTr>
            <MudTr>
                <MudTd aria-label="MudSimpleTable-Availability">Dostupnost pro mě</MudTd>
                <MudTd aria-label="MudSimpleTable-Availability-val"><b>@Course?.Extended?.Availability?.GetDescription()</b></MudTd>
            </MudTr>
        </tbody>
    </MudSimpleTable>
}
else
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
}

@code {
    [Parameter]
    public int CourseId { get; set; }
    private EventHandler<TpvUpdateEventArgs>? _updateHandler;
    private PersistingComponentStateSubscription? _subscription;
    private CourseCln? Course { get; set; }
    [CascadingParameter]
    public bool ReThrowError { get; set; }


    private async Task InitialLoad(bool forceReload = false)
    {
        Course = ApplicationState.TryTakeFromJson<CourseCln>(nameof(Course), out var cached)
            ? !forceReload ? cached : (await selectService.GetCourseInfo(CourseId, ReThrowError, FillCourseExtended.Students |
            FillCourseExtended.Availability)) 
            : (await selectService.GetCourseInfo(CourseId, ReThrowError, FillCourseExtended.Students |
            FillCourseExtended.Availability));

        StateHasChanged();
    }

    private async Task InitUpdateService()
    {
        await updateService.InitializeAsync();
        if (_updateHandler != null)
        {
            updateService.RegisterFunction(_updateHandler);
        }

        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        _subscription = ApplicationState.RegisterOnPersisting(Persist);

        _ = InitialLoad();
        _updateHandler = ((IClientUpdateHandler)this).FactoryUpdateHandler(
            [TableNames.Students, TableNames.OrderCourses],
            InitialLoad
        );
        _ = InitUpdateService();
    }

    private Task Persist()
    {
        if (Course is not null)
            ApplicationState.PersistAsJson(nameof(Course), Course);

        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _subscription?.Dispose();
        if (_updateHandler != null)
        {
            updateService.UnregisterFunction(_updateHandler);
        }
    }

    void IClientUpdateHandler.StateHasChanged()
    {
        StateHasChanged();
    }

    Task IClientUpdateHandler.InvokeAsync(Func<Task> work)
    {
        return InvokeAsync(work);
    }
}