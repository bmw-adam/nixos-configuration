@inject ISelectService selectService
@inject NavigationManager navigationManager
@inject PersistentComponentState ApplicationState
@inject IUpdateService updateService
@implements IDisposable
@implements IClientUpdateHandler

@if (Courses != null)
{
    <MudSimpleTable aria-label="mudtable-notloggedpromo" Dense="true" Hover="true" Bordered="true" Striped="false" Style="overflow-x: auto;">
        <thead>
            <MudTr>
                <MudTh aria-label="mudtable-notloggedpromo-Název">Název</MudTh>
                <MudTh aria-label="mudtable-notloggedpromo-Popis">Popis</MudTh>
                <MudTh aria-label="mudtable-notloggedpromo-Url">Url</MudTh>
                <MudTh aria-label="mudtable-notloggedpromo-Cena">Cena</MudTh>
                <MudTh aria-label="mudtable-notloggedpromo-Kapacita">Kapacita</MudTh>
                <MudTh aria-label="mudtable-notloggedpromo-Obsazenost">Obsazenost</MudTh>
            </MudTr>
        </thead>
        <tbody>
            @foreach (var course in Courses)
            {
                <MudTr aria-label="@($"mudtable-notloggedpromo-row-{course.Name}")">
                    <MudTd aria-label="@($"mudtable-notloggedpromo-row-{course.Name}-Name")">@course.Name</MudTd>
                    <MudTd aria-label="@($"mudtable-notloggedpromo-row-{course.Name}-Description")">@course.Description</MudTd>
                    <MudTd>
                        <MudLink aria-label="@($"mudtable-notloggedpromo-row-{course.Name}-Url")" Href="@course.PdfUrl">Url</MudLink>
                    </MudTd>
                    <MudTd aria-label="@($"mudtable-notloggedpromo-row-{course.Name}-Price")">@course.MaxPrice - @course.MinPrice</MudTd>
                    <MudTd aria-label="@($"mudtable-notloggedpromo-row-{course.Name}-Capacity")">@course.Capacity</MudTd>
                    <MudTd aria-label="@($"mudtable-notloggedpromo-row-{course.Name}-Occupied")">@course.Extended?.Occupied</MudTd>
                </MudTr>
            }
        </tbody>
    </MudSimpleTable>
}
else
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
}

<MudButton aria-label="loginBtn" StartIcon="@Icons.Material.Outlined.Login"
    OnClick="@(() => navigationManager.NavigateTo("/login", forceLoad: true))">Přihlásit se</MudButton>

@code {
    private PersistingComponentStateSubscription? _subscription;
    private List<CourseCln>? Courses;
    private EventHandler<TpvUpdateEventArgs>? _updateHandler;
    [CascadingParameter]
    public bool ReThrowError { get; set; }


    async Task InitialLoad(bool forceReload = false)
    {
        Courses = ApplicationState.TryTakeFromJson<IEnumerable<CourseCln>>(nameof(Courses), out var cached)
            ? !forceReload ? cached?.ToList() : (await selectService.GetAllCourses(ReThrowError, FillCourseExtended.Availability | FillCourseExtended.Occupied))?.ToList()
            : (await selectService.GetAllCourses(ReThrowError, FillCourseExtended.Availability | FillCourseExtended.Occupied))?.ToList();

        StateHasChanged();
    }
    protected override void OnInitialized()
    {
        base.OnInitialized();
        _subscription = ApplicationState.RegisterOnPersisting(Persist);

        _ = InitialLoad();
        _updateHandler = ((IClientUpdateHandler)this).FactoryUpdateHandler(
            [TableNames.Courses, TableNames.OrderCourses],
            UpdateHandler
        );

        _ = InitUpdateService();
    }

    public async Task UpdateHandler(bool forceLoad)
    {
        await InitialLoad(forceLoad);
        _ = InvokeAsync(StateHasChanged);
    }

    private async Task InitUpdateService()
    {
        await updateService.InitializeAsync();
        if (_updateHandler != null)
        {
            updateService.RegisterFunction(_updateHandler);
        }

        StateHasChanged();
    }

    private Task Persist()
    {
        if (Courses is not null)
            ApplicationState.PersistAsJson(nameof(Courses), Courses);

        return Task.CompletedTask;
    }

    public void Dispose()
    {
        _subscription?.Dispose();
        if (_updateHandler != null)
        {
            updateService.UnregisterFunction(_updateHandler);
        }
    }

    void IClientUpdateHandler.StateHasChanged()
    {
        StateHasChanged();
    }

    Task IClientUpdateHandler.InvokeAsync(Func<Task> work)
    {
        return InvokeAsync(work);
    }
}