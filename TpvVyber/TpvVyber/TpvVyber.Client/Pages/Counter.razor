@page "/counter"
@using System.Threading.Tasks
@using System.Runtime.InteropServices
@inject ISelectService SelectService
@inject ISnackbar snackbar

<PageTitle>Counter</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Counter</MudText>

@if (SortableCourses != null)
{
    <SortableList TItem="CourseCln" @ref="SortableListRef" Data="SortableCourses" Context="item" AllowSorting
        OnUpdate="@OnListUpdate">
        <ItemTemplate>
            <MudStack StretchItems="StretchItems.Middle" Row>
                <MudIconButton Icon="@Icons.Material.Filled.DragIndicator" class="drag-handle"></MudIconButton>
                <MudButton EndIcon="@Icons.Material.Filled.Info">@item.Name</MudButton>
                <MudText>@item.Id</MudText>
            </MudStack>
        </ItemTemplate>
    </SortableList>
}

<MudStack Row Spacing="5">
    <MudButton Color="Color.Secondary" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Cancel">Zrušit
    </MudButton>
    <MudButton Color="Color.Info" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Save">Ok</MudButton>
</MudStack>

@code {
    SortableList<CourseCln>? SortableListRef;
    List<CourseCln>? SortableCourses = null;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _ = InitialLoadSort();
    }

    private async Task InitialLoadSort()
    {
        var dict = await SelectService.GetSortedCoursesAsync();
        var lst = dict?.OrderBy(d => d.Key)?.Select(r => r.Value) ?? [];


        if (dict == null || lst == null)
        {
            snackbar.Add("Nepodařilo se mi získat data.");
            return;
        }

        SortableCourses = lst.ToList();

        StateHasChanged();
    }

    private void OnListUpdate(SortableListEventArgs args)
    {
        if (SortableCourses == null)
        {
            snackbar.Add("Nenačetl jsem data", Severity.Error);
            return;
        }
        Console.WriteLine($"Indicies: {args.OldIndex} -> {args.NewIndex}");

        var itemToMove = SortableCourses[args.OldIndex];
        SortableCourses.RemoveAt(args.OldIndex);

        if (args.NewIndex < SortableCourses.Count)
            SortableCourses.Insert(args.NewIndex, itemToMove);
        else
            SortableCourses.Add(itemToMove);

        Console.WriteLine($"List: {SortableCourses.Count}");
        @* _ = AsyncUpdate(); *@
    }

    private async Task AsyncUpdate()
    {
        if (SortableCourses == null)
        {
            snackbar.Add("Nenačetl jsem data", Severity.Error);
            return;
        }

        await SelectService.UpdateOrderAsync(
        SortableCourses
        .Select((course, index) => new { index, course })
        .ToDictionary(x => x.index, x => x.course)
        );
        await InitialLoadSort();
    }

    /*private async Task SortList((int oldIndex, int newIndex) indices)
    {
    var lst = _group?.Model?.Items;
    if (lst == null || lst.ToList() == null)
    {
    snackbar.Add("Nenačetl jsem data", Severity.Error);
    return;
    }

    var (oldIndex, newIndex) = indices;

    Console.WriteLine($"Indicies: {oldIndex} -> {newIndex}");

    var itemToMove = lst[oldIndex];

    if (itemToMove == null)
    {
    snackbar.Add("Nemohl jsem přeřadit element", Severity.Error);
    return;
    }

    var newDict = new Dictionary<decimal, CourseCln>();

    lst.Where(r => r != itemToMove).Select((course, index) => new KeyValuePair<decimal, CourseCln>(index,
    course)).ToList().ForEach(s => newDict.Add(s.Key, s.Value));
    newDict.Add(newIndex - (decimal)0.5, itemToMove);
    @* _group = new(ListId, new SortableListModel<CourseCln>(newDict.OrderBy(a => a.Key).Select(f => f.Value).ToList())
    {
    Settings = Settings
    }); *@

    Console.WriteLine($"List: {lst.Count}");

    await SelectService.UpdateOrderAsync(newDict.Select(s => new KeyValuePair<int, CourseCln>((int)(s.Key * 2),
    s.Value)).ToDictionary());
    await InitialLoadSort();
    @* StateHasChanged(); *@
    }*/
}