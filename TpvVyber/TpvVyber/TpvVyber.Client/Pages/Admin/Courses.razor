@page "/admin/courses"
@attribute [Authorize(Roles = "Admin")]
@inject NavigationManager NavigationManager
@inject PersistentComponentState ApplicationState
@inject IAdminService AdminService
@implements IDisposable

@if (CoursesData is null)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="my-6" />
}
else
{
    <MudDataGrid aria-label="grid-adm-courses" @ref="courseGrid" Context="context" T="CourseCln" Items="@CoursesData"
        ReadOnly="false" EditMode="DataGridEditMode.Cell" CommittedItemChanges="@CommittedItemChanges" Bordered="true"
        Dense="true" EditTrigger="DataGridEditTrigger.OnRowClick">
        <ToolBarContent>
            <MudText aria-label="grid-adm-courses-lbl-kurzy" Typo="Typo.h6">Kurzy</MudText>
            <MudSpacer />
            <MudButtonGroup Class="ma-0 pa-0" Color="Color.Success" Variant="Variant.Outlined">
                <MudButton aria-label="grid-adm-courses-add-course" OnClick="NewItemAsync">Přidat nový kurz</MudButton>
            </MudButtonGroup>
        </ToolBarContent>
        <Columns>
            <HierarchyColumn Hidden />
            <PropertyColumn Property="x => x.Id" Title="Id" Editable="false" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-Name-val")" Title="Název" Property="x => x.Name" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-Description-val")" Title="Popis"
                Property="x => x.Description" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-ForClasses-val")" Title="Pro třídy"
                Property="x => x.ForClasses" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-Capacity-val")" Title="Kapacita"
                Property="x => x.Capacity" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-MinCapacity-val")" Title="Min. Kapacita"
                Property="x => x.MinCapacity" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-MinPrice-val")" Title="Min. Napl. Cena"
                Property="x => x.MinPrice" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-MaxPrice-val")" Title="Max. Napl. Cena"
                Property="x => x.MaxPrice" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-PdfUrl-val")" Title="Pdf url" Property="x => x.PdfUrl" />
            <TemplateColumn Title="Seznam kurzů">
                <CellTemplate>
                    <MudButton aria-label="@($"grid-adm-courses-grid-StuList-val")" OnClick="() => ExpandRow(context.Item)"
                        StartIcon="@Icons.Material.Outlined.List" Size="Size.Small">Seznam žáků</MudButton>
                </CellTemplate>
                <EditTemplate>
                    <MudButton aria-label="@($"grid-adm-courses-grid-StuList-val")" OnClick="() => ExpandRow(context.Item)"
                        StartIcon="@Icons.Material.Outlined.List" Size="Size.Small">Seznam žáků</MudButton>
                </EditTemplate>
            </TemplateColumn>

            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton aria-label="@($"grid-adm-courses-grid-delStu-val")" Size="Size.Small"
                        Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => DeleteItemAsync(context.Item))" />
                </CellTemplate>
                <EditTemplate>
                    <MudIconButton aria-label="@($"grid-adm-courses-grid-delStu-val")" Size="Size.Small"
                        Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => DeleteItemAsync(context.Item))" />
                </EditTemplate>
            </TemplateColumn>
        </Columns>
        <ChildRowContent>
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Name")" Typo="Typo.h6">Seznam žáků
                            - @context.Item.Name</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (context.Item?.Extended?.Students != null)
                    {
                        <MudDataGrid T="StudentCln" Items="context.Item.Extended.Students" ReadOnly="true" Bordered="true"
                            Dense="true">
                            <Columns>
                                <PropertyColumn aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Id")"
                                    Property="x => x.Id" Title="Id" />
                                <PropertyColumn aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Jméno")"
                                    Property="x => x.Name" Title="Jméno" />
                                <PropertyColumn aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Email")"
                                    Property="x => x.Email" Title="Email" />
                                <TemplateColumn aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Pořadí")"
                                    Title="Pořadí" Editable="false">
                                    <CellTemplate Context="student">
                                        <MudText>
                                            @string.Join(", ", context.Item.Extended.OrderCourses?.Where(oc => oc.StudentId ==
                                            student.Item.Id)
                                                                        .Select(oc => oc.Order) ?? [])
                                </MudText>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
                                }
                    else
                    {
                        <MudText>Error - extended je null</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </ChildRowContent>

    </MudDataGrid>
}

@code {
    private List<CourseCln>? CoursesData;
    private MudDataGrid<CourseCln> courseGrid = default!;
    private PersistingComponentStateSubscription? _subscription;
    [CascadingParameter]
    public bool ReThrowError { get; set; }

    protected override void OnInitialized()
    {
        _subscription = ApplicationState.RegisterOnPersisting(Persist);
        _ = LoadData();
    }

    private async Task LoadData()
    {
        if (ApplicationState.TryTakeFromJson<IEnumerable<CourseCln>>(nameof(CoursesData), out var cached))
        {
            CoursesData = cached?.ToList();
        }
        if (CoursesData == null || CoursesData.Count == 0)
        {
            CoursesData = new List<CourseCln>();
            _ = InvokeAsync(StateHasChanged);

            // Stream items one by one
            await foreach (var course in AdminService.GetAllCoursesAsync(ReThrowError, FillCourseExtended.Students |
            FillCourseExtended.OrderCourses))
            {
                if (RendererInfo.Name == "WebAssembly")
                {
                    CoursesData.Add(course);
                    StateHasChanged();
                    await Task.Delay(1);
                }
                else
                {
                    CoursesData.Add(course);
                    _ = InvokeAsync(StateHasChanged);
                }
            }
        }
    }

    private Task Persist()
    {
        if (CoursesData is not null)
            ApplicationState.PersistAsJson(nameof(CoursesData), CoursesData);

        return Task.CompletedTask;
    }

    public void Dispose() => _subscription?.Dispose();

    private async Task NewItemAsync()
    {
        var newCourse = await AdminService.AddCourseAsync(new CourseCln(), ReThrowError);
        if (newCourse is not null)
        {
            CoursesData?.Insert(0, newCourse);
        }
    }

    private async Task DeleteItemAsync(CourseCln item)
    {
        await AdminService.DeleteCourseAsync(item.Id, ReThrowError);
        CoursesData?.Remove(item);
    }

    private void CommittedItemChanges(CourseCln item)
    {
        _ = CommitDataAsync(item);
    }

    private async Task CommitDataAsync(CourseCln course)
    {
        await AdminService.UpdateCourseAsync(course, ReThrowError);
    }

    private void ExpandRow(CourseCln item)
    {
        _ = courseGrid.ToggleHierarchyVisibilityAsync(item);
    }
}