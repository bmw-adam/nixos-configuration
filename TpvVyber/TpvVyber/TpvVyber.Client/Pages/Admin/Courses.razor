@page "/admin/courses"
@attribute [Authorize(Roles = "Admin")]
@inject NavigationManager NavigationManager
@inject PersistentComponentState ApplicationState
@inject IAdminService AdminService
@implements IDisposable

@if (CoursesData is null)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="my-6" />
}
else
{
    <MudDataGrid @ref="courseGrid" T="CourseCln" Items="@CoursesData" ReadOnly="false" EditMode="DataGridEditMode.Cell"
        CommittedItemChanges="@CommittedItemChanges" Bordered="true" Dense="true"
        EditTrigger="DataGridEditTrigger.OnRowClick">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Kurzy</MudText>
            <MudSpacer />
            <MudButtonGroup Class="ma-0 pa-0" Color="Color.Success" Variant="Variant.Outlined">
                <MudButton OnClick="NewItemAsync">Přidat nový kurz</MudButton>
            </MudButtonGroup>
        </ToolBarContent>
        <Columns>
            <HierarchyColumn Hidden />
            <PropertyColumn Property="x => x.Id" Title="Id" Editable="false" />
            <PropertyColumn Title="Název" Property="x => x.Name" />
            <PropertyColumn Title="Popis" Property="x => x.Description" />
            <PropertyColumn Title="Pro třídy" Property="x => x.ForClasses" />
            <PropertyColumn Title="Kapacita" Property="x => x.Capacity" />
            <PropertyColumn Title="Min. Kapacita" Property="x => x.MinCapacity" />
            <PropertyColumn Title="Min. Napl. Cena" Property="x => x.MinPrice" />
            <PropertyColumn Title="Max. Napl. Cena" Property="x => x.MaxPrice" />
            <PropertyColumn Title="Pdf url" Property="x => x.PdfUrl" />
            <TemplateColumn Title="Seznam kurzů">
                <CellTemplate>
                    <MudButton OnClick="() => ExpandRow(context.Item)" StartIcon="@Icons.Material.Outlined.List"
                        Size="Size.Small">Seznam žáků</MudButton>
                </CellTemplate>
                <EditTemplate>
                    <MudButton OnClick="() => ExpandRow(context.Item)" StartIcon="@Icons.Material.Outlined.List"
                        Size="Size.Small">Seznam žáků</MudButton>
                </EditTemplate>
            </TemplateColumn>

            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Outlined.Delete"
                        OnClick="@(() => DeleteItemAsync(context.Item))" />
                </CellTemplate>
                <EditTemplate>
                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Outlined.Delete"
                        OnClick="@(() => DeleteItemAsync(context.Item))" />
                </EditTemplate>
            </TemplateColumn>
        </Columns>
        <ChildRowContent>
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Seznam žáků - @context.Item.Name</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (context.Item?.Extended?.Students != null)
                    {
                        <MudDataGrid T="StudentCln" Items="context.Item.Extended.Students" ReadOnly="true" Bordered="true"
                            Dense="true">
                            <Columns>
                                <PropertyColumn Property="x => x.Id" Title="Id" />
                                <PropertyColumn Property="x => x.Name" Title="Jméno" />
                                <PropertyColumn Property="x => x.Email" Title="Email" />
                                <TemplateColumn Title="Pořadí" Editable="false">
                                    <CellTemplate Context="student">
                                        <MudText>@string.Join(", ", OrderCourses?.Where(oc => oc.StudentId == student.Item.Id &&
                                                                                oc.CourseId == context.Item.Id).Select(oc => oc.Order) ?? [])</MudText>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
                                }
                    else
                    {
                        <MudText>Error - extended je null</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </ChildRowContent>

    </MudDataGrid>
}

@code {
    private List<CourseCln>? CoursesData;
    private MudDataGrid<CourseCln> courseGrid = default!;
    private PersistingComponentStateSubscription? _subscription;
    [CascadingParameter]
    public bool ReThrowError { get; set; }

    private List<OrderCourseCln>? OrderCourses;

    protected override async Task OnInitializedAsync()
    {
        _subscription = ApplicationState.RegisterOnPersisting(Persist);

        CoursesData = ApplicationState.TryTakeFromJson<IEnumerable<CourseCln>>(nameof(CoursesData), out var cached)
        ? cached?.ToList()
        : (await AdminService.GetAllCoursesAsync(ReThrowError, FillCourseExtended.Students)).ToList();


        OrderCourses = ApplicationState.TryTakeFromJson<IEnumerable<OrderCourseCln>>(nameof(OrderCourses), out var
        cachedOrderCourses)
        ? cachedOrderCourses?.ToList()
        : (await AdminService.GetAllOrderCourseAsync(ReThrowError, FillOrderCourseExtended.Student |
        FillOrderCourseExtended.Course)).ToList();
    }

    private Task Persist()
    {
        if (CoursesData is not null)
            ApplicationState.PersistAsJson(nameof(CoursesData), CoursesData);

        if (OrderCourses is not null)
            ApplicationState.PersistAsJson(nameof(OrderCourses), OrderCourses);
        return Task.CompletedTask;
    }

    public void Dispose() => _subscription?.Dispose();

    private async Task NewItemAsync()
    {
        var newCourse = await AdminService.AddCourseAsync(new CourseCln(), ReThrowError);
        if (newCourse is not null)
        {
            CoursesData?.Insert(0, newCourse);
        }
    }

    private async Task DeleteItemAsync(CourseCln item)
    {
        await AdminService.DeleteCourseAsync(item.Id, ReThrowError);
        CoursesData?.Remove(item);
    }

    private void CommittedItemChanges(CourseCln item)
    {
        _ = CommitDataAsync(item);
    }

    private async Task CommitDataAsync(CourseCln course)
    {
        await AdminService.UpdateCourseAsync(course, ReThrowError);
        // Only reload if needed, often unnecessary if your grid binds to CoursesData
    }

    private void ExpandRow(CourseCln item)
    {
        _ = courseGrid.ToggleHierarchyVisibilityAsync(item);
    }
}