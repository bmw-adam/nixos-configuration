@page "/admin/courses"
@using System.Runtime.InteropServices
@attribute [Authorize(Roles = "Admin")]
@inject NavigationManager NavigationManager
@inject PersistentComponentState ApplicationState
@inject IAdminService AdminService
@implements IDisposable
@inject IJSRuntime jSRuntime
@inject IUpdateService updateService
@implements IClientUpdateHandler
@implements IInteractiveGrid

@if (CoursesData is null)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="my-6" />
}
else
{
    <MudDataGrid aria-label="grid-adm-courses" @ref="courseGrid" Context="context" T="CourseCln" Items="@CoursesData"
        ReadOnly="false" EditMode="DataGridEditMode.Cell" CommittedItemChanges="@CommittedItemChanges" Bordered="true"
        Dense="true" EditTrigger="DataGridEditTrigger.OnRowClick">
        <ToolBarContent>
            <MudText aria-label="grid-adm-courses-lbl-kurzy" Typo="Typo.h6">Kurzy</MudText>
            <MudSpacer />
            <MudButtonGroup Class="ma-0 pa-0" Color="Color.Success" Variant="Variant.Outlined">
                <MudButton aria-label="grid-adm-courses-add-course" OnClick="NewItemAsync">Přidat nový kurz</MudButton>
            </MudButtonGroup>
        </ToolBarContent>
        <Columns>
            <HierarchyColumn Hidden />
            <PropertyColumn Property="x => x.Id" Title="Id" Editable="false" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-Name-val")" Title="Název" Property="x => x.Name" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-Description-val")" Title="Popis"
                Property="x => x.Description" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-ForClasses-val")" Title="Pro třídy"
                Property="x => x.ForClasses" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-Capacity-val")" Title="Kapacita"
                Property="x => x.Capacity" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-MinCapacity-val")" Title="Min. Kapacita"
                Property="x => x.MinCapacity" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-MinPrice-val")" Title="Min. Napl. Cena"
                Property="x => x.MinPrice" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-MaxPrice-val")" Title="Max. Napl. Cena"
                Property="x => x.MaxPrice" />
            <PropertyColumn aria-label="@($"grid-adm-courses-grid-PdfUrl-val")" Title="Pdf url" Property="x => x.PdfUrl" />
            <TemplateColumn Title="Seznam kurzů">
                <CellTemplate>
                    <MudButton aria-label="@($"grid-adm-courses-grid-StuList-val")" OnClick="() => ExpandRow(context.Item)"
                        StartIcon="@Icons.Material.Outlined.List" Size="Size.Small">Vnořené seznamy</MudButton>
                </CellTemplate>
                <EditTemplate>
                    <MudButton aria-label="@($"grid-adm-courses-grid-StuList-val")" OnClick="() => ExpandRow(context.Item)"
                        StartIcon="@Icons.Material.Outlined.List" Size="Size.Small">Vnořené seznamy</MudButton>
                </EditTemplate>
            </TemplateColumn>

            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton aria-label="@($"grid-adm-courses-grid-delStu-val")" Size="Size.Small"
                        Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => DeleteItemAsync(context.Item))" />
                </CellTemplate>
                <EditTemplate>
                    <MudIconButton aria-label="@($"grid-adm-courses-grid-delStu-val")" Size="Size.Small"
                        Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => DeleteItemAsync(context.Item))" />
                </EditTemplate>
            </TemplateColumn>
        </Columns>
        <ChildRowContent>
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Name")" Typo="Typo.h6">Seznam žáků
                            - @context.Item.Name</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (context.Item?.Extended?.Students != null)
                    {
                        <MudDataGrid T="StudentCln" Items="context.Item.Extended.Students" ReadOnly="true" Bordered="true"
                            Dense="true">
                            <Columns>
                                <PropertyColumn aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Id")"
                                    Property="x => x.Id" Title="Id" />
                                <PropertyColumn aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Jméno")"
                                    Property="x => x.Name" Title="Jméno" />
                                <PropertyColumn aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Email")"
                                    Property="x => x.Email" Title="Email" />
                                <TemplateColumn aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Pořadí")"
                                    Title="Pořadí" Editable="false">
                                    <CellTemplate Context="student">
                                        <MudText>
                                            @string.Join(", ", context.Item.Extended.OrderCourses?.Where(oc => oc.StudentId ==
                                            student.Item.Id).Select(oc => oc.Order) ?? [])
                                </MudText>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
                                }
                    else
                    {
                        <MudText>Error - extended je null</MudText>
                    }
                </MudCardContent>
            </MudCard>
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText aria-label="@($"grid-adm-courses-grid-StuList-val-nested-Name")" Typo="Typo.h6">Seznam Historie účastí
                            - @context.Item.Name</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (context.Item?.Extended?.AttendanceHistory != null)
                    {
                        <MudDataGrid T="StudentCln" Items="context.Item.Extended.AttendanceHistory" ReadOnly="true" Bordered="true"
                            Dense="true">
                            <Columns>
                                <PropertyColumn aria-label="@($"grid-adm-courses-grid-hislist-val-nested-Id")"
                                    Property="x => x.Id" Title="Id" />
                                <PropertyColumn aria-label="@($"grid-adm-courses-grid-hislist-val-nested-Jméno")"
                                    Property="x => x.Name" Title="Jméno" />
                                <PropertyColumn aria-label="@($"grid-adm-courses-grid-hislist-val-nested-Email")"
                                    Property="x => x.Email" Title="Email" />
                    </Columns>
                </MudDataGrid>
                                }
                    else
                    {
                        <MudText>Error - extended je null</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </ChildRowContent>
        <PagerContent>
            <MudDataGridPager T="CourseCln" />
        </PagerContent>
    </MudDataGrid>

    <MudButtonGroup Color="Color.Info" Variant="Variant.Outlined">
        <MudFileUpload T="IBrowserFile" Accept=".csv" FilesChanged="UploadCsv" MaximumFileCount="100">
            <ActivatorContent>
                <MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.CloudUpload">
                    Nahrát csv
                </MudButton>
            </ActivatorContent>
        </MudFileUpload>
        <MudMenu Icon="@Icons.Material.Filled.ArrowDropDown" Style="align-self: auto;">
            <MudMenuItem OnClick="DownloadCsv">Stáhnout vzorové csv</MudMenuItem>
        </MudMenu>
    </MudButtonGroup>
}

@code {
    private List<CourseCln>? CoursesData;
    private EventHandler<TpvUpdateEventArgs>? _updateHandler;
    private MudDataGrid<CourseCln> courseGrid = default!;
    private PersistingComponentStateSubscription? _subscription;
    [CascadingParameter]
    public bool ReThrowError { get; set; }

    protected override void OnInitialized()
    {
        _subscription = ApplicationState.RegisterOnPersisting(Persist);

        _ = LoadData(true);

        _updateHandler = ((IClientUpdateHandler)this).FactoryUpdateHandler([TableNames.Courses, TableNames.OrderCourses, TableNames.Students], LoadData);
        if (_updateHandler is not null)
        {
            updateService.RegisterFunction(_updateHandler);
        }
    }

    private async Task LoadData(bool forceLoad)
    {
        if (!forceLoad && ApplicationState.TryTakeFromJson<IEnumerable<CourseCln>>(nameof(CoursesData), out var cached))
        {
            CoursesData = cached?.ToList();
        }

        int currentPage = courseGrid is null ? 0 : courseGrid.CurrentPage;
        int rowsPerPage = courseGrid is null ? 10 : courseGrid.RowsPerPage;

        if (forceLoad || (CoursesData == null || CoursesData.Count == 0 || !ApplicationState.TryTakeFromJson<int>(nameof(CoursesData), out var _)))
        {
            if (CoursesData == null)
            {
                CoursesData = new List<CourseCln>();
            }

            await ((IInteractiveGrid)this).ReloadDataAsync(AdminService.GetAllCoursesAsync(ReThrowError, FillCourseExtended.Students | FillCourseExtended.OrderCourses | FillCourseExtended.AttendanceHistory), CoursesData, currentPage, rowsPerPage);
        }
        StateHasChanged();
    }

    private Task Persist()
    {
        if (CoursesData is not null)
            ApplicationState.PersistAsJson(nameof(CoursesData), CoursesData);

        return Task.CompletedTask;
    }

    public void Dispose()
    {
        if (_updateHandler is not null)
        {
            updateService.UnregisterFunction(_updateHandler);
        }
        _subscription?.Dispose();
    }

    private async Task NewItemAsync()
    {
        var newCourse = await AdminService.AddCourseAsync(new CourseCln(), ReThrowError);
    }

    private async Task DeleteItemAsync(CourseCln item)
    {
        await AdminService.DeleteCourseAsync(item.Id, ReThrowError);
    }

    private void CommittedItemChanges(CourseCln item)
    {
        _ = CommitDataAsync(item);
    }

    private async Task CommitDataAsync(CourseCln course)
    {
        await AdminService.UpdateCourseAsync(course, ReThrowError);
    }

    private void ExpandRow(CourseCln item)
    {
        _ = courseGrid.ToggleHierarchyVisibilityAsync(item);
    }

    private async Task UploadCsv(IBrowserFile file)
    {
        var courses = new List<CourseCln>();
        using var stream = file.OpenReadStream();
        using var reader = new StreamReader(stream);

        bool isHeader = true;

        var line = string.Empty;
        while ((line = await reader.ReadLineAsync()) != null)
        {
            if (string.IsNullOrWhiteSpace(line))
            {
                continue;
            }

            if (isHeader)
            {
                isHeader = false;
                continue;
            }

            var columns = line.Split(";");

            if (columns.Length != 8)
            {
                continue;
            }

            courses.Add
            (
            new CourseCln
            {
                Name = columns[0].Trim(),
                Description = columns[1].Trim(),
                PdfUrl = columns[2].Trim(),
                ForClasses = columns[3].Trim().Replace("-", ";"),
                MinPrice = int.Parse(columns[4].Trim()),
                MaxPrice = int.Parse(columns[5].Trim()),
                Capacity = uint.Parse(columns[6].Trim()),
                MinCapacity = uint.Parse(columns[7].Trim()),
            }
            );
        }

        foreach (var course in courses)
        {
            var newCse = AdminService.AddCourseAsync(course, ReThrowError);
        }

        await LoadData(true);
        StateHasChanged();
        _ = InvokeAsync(StateHasChanged);
        Thread.Sleep(1);
    }

    private async Task DownloadCsv()
    {
        await jSRuntime.InvokeVoidAsync("downloadFile", "Example-Courses.csv");
    }

    void IClientUpdateHandler.StateHasChanged()
    {
        StateHasChanged();
    }

    Task IClientUpdateHandler.InvokeAsync(Func<Task> work)
    {
        return InvokeAsync(work);
    }

    void IInteractiveGrid.StateHasChanged()
    {
        StateHasChanged();
    }

    Task IInteractiveGrid.InvokeAsync(Func<Task> work)
    {
        return InvokeAsync(work);
    }

    Task IInteractiveGrid.InvokeAsync(Action work)
    {
        return InvokeAsync(work);
    }

    IAdminService IInteractiveGrid.AdminService => AdminService;
}