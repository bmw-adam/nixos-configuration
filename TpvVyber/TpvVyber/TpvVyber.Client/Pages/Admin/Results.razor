@page "/admin/results"
@attribute [Authorize(Roles = "Admin")]
@using System.Text
@using System.IO
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components
@inject IAdminService AdminService
@inject PersistentComponentState ApplicationState
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Výsledky</PageTitle>
<MudText Typo="Typo.h4">Výsledky</MudText>

<MudText Typo="Typo.h6">Konec:</MudText>
<MudStack Row>
    <MudDatePicker Label="Datum" @bind-Date="LoggingEndTime"></MudDatePicker>
    <MudTimePicker Label="čas" @bind-Time="LoggingEndTimeSpan"></MudTimePicker>
    <MudButton OnClick="SubmitDateTime">Ok</MudButton>
</MudStack>
<div style="height: 20px;"></div>
<MudPaper Class="doc-section-component-container">
    <MudChart ChartType="MudBlazor.ChartType.StackedBar" ChartSeries="@_series" @bind-SelectedIndex="_index"
        XAxisLabels="@_xAxisLabels" Width="100%" Height="auto" AxisChartOptions="_axisChartOptions"></MudChart>
</MudPaper>
<MudText Typo="Typo.caption"><i>Kolik lidí si dalo kurz na kolikáté pořadí?</i></MudText>

<div style="height: 10px"></div>
<MudText Typo="Typo.h4">Pořadí - Výsledky</MudText>
<MudTable Items="@(Students ?? [])" Hover="true" Breakpoint="Breakpoint.Sm"
    Loading="@(StudentCourses == null || Students == null)" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>Třída</MudTh>
        <MudTh>Jméno žáka</MudTh>
        <MudTh>E-Mail</MudTh>
        <MudTh>Název kurzu</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Třída">@GetClassName(context.Class)</MudTd>
        <MudTd DataLabel="Jméno žáka">@context.Name</MudTd>
        <MudTd DataLabel="E-Mail">@context.Email</MudTd>
        <MudTd DataLabel="Název kurzu">@GetCourseNameForStudent(context)</MudTd>
    </RowTemplate>
</MudTable>

<MudButton StartIcon="@Icons.Material.Outlined.ImportExport" OnClick="ExportCsv" Variant="Variant.Filled"
    Color="Color.Primary">
    Export CSV
</MudButton>

@code {
    private PersistingComponentStateSubscription? _subscription;
    [CascadingParameter]
    public bool ReThrowError { get; set; }

    private Dictionary<CourseCln, List<StudentCln>>? StudentCourses;
    private List<StudentCln>? Students { get; set; }
    private List<CourseCln>? Courses { get; set; }
    private DateTime? LoggingEndTime;
    private TimeSpan? LoggingEndTimeSpan;
    private LoggingEndingCln? loggingEndingCln;

    private int _index = -1; //default value cannot be 0 -> first selectedindex is 0.
    private AxisChartOptions _axisChartOptions = new AxisChartOptions();

    private List<ChartSeries> _series = new List<ChartSeries>();
    private string[] _xAxisLabels = { };

    protected override void OnInitialized()
    {
        base.OnInitialized();
        _subscription = ApplicationState.RegisterOnPersisting(Persist);
        _ = AsyncLoad();
    }

    private async Task<Dictionary<CourseCln, List<StudentCln>>> ApiCall()
    {
        var dict = await AdminService.ShowFillCourses(true, ReThrowError, FillCourseExtended.Students, null);
        var coursesDict = new Dictionary<CourseCln, List<StudentCln>>();

        foreach (var pair in dict)
        {
            var course = await AdminService.GetCourseByIdAsync(pair.Key, ReThrowError, null);
            if (course != null)
            {
                coursesDict.Add(course, pair.Value.ToList());
            }
        }
        return coursesDict;
    }

    private async Task AsyncLoad()
    {
        StudentCourses = ApplicationState.TryTakeFromJson<Dictionary<CourseCln, List<StudentCln>>>(nameof(StudentCourses), out
        var cached)
        ? cached
        : (await ApiCall());

        Students = ApplicationState.TryTakeFromJson<List<StudentCln>>(nameof(Students), out
        var cachedStudents)
        ? cachedStudents
        : ((await AdminService.GetAllStudentsAsync(ReThrowError, FillStudentExtended.Courses |
        FillStudentExtended.OrderCourses)).ToList());

        Courses = ApplicationState.TryTakeFromJson<List<CourseCln>>(nameof(Courses), out
        var cachedCourses)
        ? cachedCourses
        : ((await AdminService.GetAllCoursesAsync(ReThrowError, FillCourseExtended.OrderCourses |
        FillCourseExtended.Students)).ToList());


        _xAxisLabels = (StudentCourses?.Select(e => e.Key.Name).ToArray() ?? []).Order().ToArray();

        foreach (var order in (Students?.SelectMany(e => e.Extended?.OrderCourses ?? [])?.Where(r => r is not null) ??
        []).Select(r => r.Order).Distinct())
        {
            _series.Add(
            new ChartSeries()
            {
                Name = $"Pořadí {order}",
                Data = _xAxisLabels.Select(a => Courses?.FirstOrDefault(s => s.Name == a)).Select(r =>
    r?.Extended?.OrderCourses?.Where(d => d.Order == order)).Select(q => q?.Count() ?? 0).Select(r => (double)r).ToArray()
            }
            );
        }

        var loggingEnd = await AdminService.GetLoggingEndings(ReThrowError);
        if (loggingEnd?.TimeEnding != null)
        {
            LoggingEndTime = loggingEnd.TimeEnding.Date;
            LoggingEndTimeSpan = loggingEnd.TimeEnding - loggingEnd.TimeEnding.Date;
        }
        loggingEndingCln = loggingEnd;
        StateHasChanged();
    }
    public void Dispose() => _subscription?.Dispose();

    private Task Persist()
    {
        if (StudentCourses is not null)
            ApplicationState.PersistAsJson(nameof(StudentCourses), StudentCourses);

        if (Students is not null)
            ApplicationState.PersistAsJson(nameof(Students), Students);

        if (Courses is not null)
            ApplicationState.PersistAsJson(nameof(Courses), Courses);

        return Task.CompletedTask;
    }

    private string GetClassName(string classRoles)
    {
        var roles = classRoles.Split(";");
        return roles.OrderByDescending(e => ClassExtensions.CalculateClaimStrenght(e)).FirstOrDefault() ?? "";
    }

    async Task SubmitDateTime()
    {
        if (LoggingEndTimeSpan == null || LoggingEndTime == null || loggingEndingCln == null)
        {
            return;
        }
        loggingEndingCln.TimeEnding = LoggingEndTime.Value.Add(LoggingEndTimeSpan.Value);
        await AdminService.UpdateLoggingEnding(loggingEndingCln, ReThrowError);
        await AsyncLoad();
    }

    // Helper method to ensure Table and CSV use identical logic
    private string GetCourseNameForStudent(StudentCln student)
    {
        return StudentCourses?.FirstOrDefault(e => e.Value.Select(q => q.Id).Contains(student.Id)).Key?.Name ?? "";
    }
    private async Task ExportCsv()
    {
        if (Students == null) return;

        // Use Semicolon for Czech Excel compatibility
        var separator = ";";
        var sb = new StringBuilder();

        // 1. Header
        sb.AppendLine($"Třída{separator}Jméno žáka{separator}E-Mail{separator}Název kurzu");

        // 2. Data Rows
        foreach (var student in Students)
        {
            var className = GetClassName(student.Class);
            var studentName = student.Name;
            var email = student.Email;
            var courseName = GetCourseNameForStudent(student);

            // Simple sanitization to prevent CSV breaking if data contains the separator
            var line =
            $"{ClassExtensions.EscapeCsv(className)}{separator}{ClassExtensions.EscapeCsv(studentName)}{separator}{ClassExtensions.EscapeCsv(email)}{separator}{ClassExtensions.EscapeCsv(courseName)}";
            sb.AppendLine(line);
        }

        // 3. Create Stream with UTF8 BOM (Byte Order Mark) so Excel opens it correctly
        using var stream = new MemoryStream();
        using var writer = new StreamWriter(stream, new UTF8Encoding(encoderShouldEmitUTF8Identifier: true));
        await writer.WriteAsync(sb.ToString());
        await writer.FlushAsync();
        stream.Position = 0;

        // 4. Trigger Download via JS
        using var streamRef = new DotNetStreamReference(stream);
        await JS.InvokeVoidAsync("downloadFileFromStream", "Vysledky.csv", streamRef);
    }
}