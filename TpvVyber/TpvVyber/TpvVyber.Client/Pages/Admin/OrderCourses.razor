@page "/admin/ordercourses"
@using System.Runtime.InteropServices
@attribute [Authorize(Roles = "Admin")]
@inject NavigationManager NavigationManager
@inject PersistentComponentState ApplicationState
@inject IAdminService AdminService
@inject IDialogService DialogService
@implements IDisposable
@inject IUpdateService updateService
@implements IClientUpdateHandler
@implements IInteractiveGrid

@if (OrderCourseData is null)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="my-6" />
}
else
{
    <MudDataGrid @ref="OrderCourseGrid" T="OrderCourseCln" Items="@OrderCourseData" ReadOnly="false"
                 EditMode="DataGridEditMode.Cell" CommittedItemChanges="@CommittedItemChanges"
                 Bordered="true" Dense="true" EditTrigger="DataGridEditTrigger.OnRowClick">
        <ToolBarContent>
            <MudText aria-label="admin-ordercourses-table-header" Typo="Typo.h6">Pořadí kurzů</MudText>
            <MudSpacer />
            <MudButtonGroup Class="ma-0 pa-0" Color="Color.Success" Variant="Variant.Outlined">
                <MudButton aria-label="admin-ordercourses-table-header-btn-add" OnClick="NewItemAsync">Přidat pořadí kurzu</MudButton>
            </MudButtonGroup>
        </ToolBarContent>
        <Columns>
            <PropertyColumn aria-label="admin-ordercourses-table-value-id" Property="x => x.Id" Title="Id" Editable="false" />
            <PropertyColumn aria-label="admin-ordercourses-table-value-order" Property="x => x.Order" Title="Order" />
            <PropertyColumn aria-label="admin-ordercourses-table-value-courseid" Editable="false" Property="x => x.CourseId" Title="Course Id" />

            <TemplateColumn Title="Kurz" CellClass="d-flex">
                <CellTemplate>
                    <MudText aria-label="admin-ordercourses-table-value-kurz">@context.Item.Extended?.Course?.Name</MudText>
                </CellTemplate>
                <EditTemplate>
                    @if (context.Item.Extended != null)
                    {
                        <MudSelect aria-label="admin-ordercourses-table-value-kurz" Style="display: block;" T="CourseCln" Value="context.Item.Extended.Course" 
                                   ValueChanged="(value) => ChangeValueCourse(context.Item, value)" 
                                   ToStringFunc="s => s.Name" Required="true"
                                   RequiredError="Kurz je povinný!" HelperText="Vyberte kurz">
                        @foreach (var course in AvailableCourses)
                        {
                            <MudSelectItem aria-label="@($"admin-ordercourses-table-value-kurz-select-item-{course.Name}")" T="CourseCln" Value="course">@course.Name</MudSelectItem>
                        }
                        </MudSelect>
                    }
                    else 
                    {
                        <MudText>Error - nenalezen žák</MudText>
                    }
                </EditTemplate>

            </TemplateColumn>
            
            <PropertyColumn aria-label="admin-ordercourses-table-value-studentid" Editable="false" Property="x => x.StudentId" Title="Žák Id" />
            
            <TemplateColumn Title="Žák">
                <CellTemplate>
                    <MudText aria-label="admin-ordercourses-table-value-student">@context.Item.Extended?.Student?.Name</MudText>
                </CellTemplate>
                <EditTemplate>
                    @if (context.Item.Extended != null)
                    {
                        <MudSelect aria-label="admin-ordercourses-table-value-student" Style="display: block;" T="StudentCln" Value="context.Item.Extended.Student" 
                                   ValueChanged="(value) => ChangeValueStudent(context.Item, value)" 
                                   ToStringFunc="s => s.Name" Required="true"
                                   RequiredError="Žák je povinný!" HelperText="Vyberte žáka">
                        @foreach (var student in AvailableStudents)
                        {
                            <MudSelectItem aria-label="@($"admin-ordercourses-table-value-student-select-value-{student.Name}")" T="StudentCln" Value="student">@student.Name</MudSelectItem>
                        }
                        </MudSelect>
                    }
                    else 
                    {
                        <MudText>Error - nenalezen žák</MudText>
                    }
                </EditTemplate>
            </TemplateColumn>

            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton aria-label="admin-ordercourses-table-delete-btn" Size="Size.Small" Icon="@Icons.Material.Outlined.Delete"
                                   OnClick="@(() => DeleteItemAsync(context.Item))" />
                </CellTemplate>
                <EditTemplate>
                    <MudIconButton aria-label="admin-ordercourses-table-delete-btn" Size="Size.Small" Icon="@Icons.Material.Outlined.Delete"
                                   OnClick="@(() => DeleteItemAsync(context.Item))" />
                </EditTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="OrderCourseCln" />
        </PagerContent>
    </MudDataGrid>
}

@code {
    private List<OrderCourseCln>? OrderCourseData; // Keep this null initially to show spinner
    private MudDataGrid<OrderCourseCln> OrderCourseGrid = default!;

    private List<CourseCln> AvailableCourses = new();
    private List<StudentCln> AvailableStudents = new();
    private PersistingComponentStateSubscription? _subscription;
    private EventHandler<TpvUpdateEventArgs>? _updateHandler;

    [CascadingParameter]
    public bool ReThrowError { get; set; }

    protected override void OnInitialized()
    {
        _subscription = ApplicationState.RegisterOnPersisting(Persist);
        _ = LoadData(true);
        _updateHandler = ((IClientUpdateHandler)this).FactoryUpdateHandler(
            [TableNames.OrderCourses, TableNames.Courses, TableNames.Students],
            LoadData
        );

        if (_updateHandler is not null)
        {
            updateService.RegisterFunction(_updateHandler);
        }
    }

    private async Task LoadData(bool forceLoad = false)
    {
        // Load dependencies first
        await LoadCoursesAsync(forceLoad);
        await LoadStudentsAsync(forceLoad);
        
        // Then load the main grid data
        await LoadOrdersAsync(forceLoad);
    }

    private Task Persist()
    {
        if (OrderCourseData is not null)
            ApplicationState.PersistAsJson(nameof(OrderCourseData), OrderCourseData);

        if (AvailableCourses.Any())
            ApplicationState.PersistAsJson(nameof(AvailableCourses), AvailableCourses);

        if (AvailableStudents.Any())
            ApplicationState.PersistAsJson(nameof(AvailableStudents), AvailableStudents);

        return Task.CompletedTask;
    }

    public void Dispose() 
    {
        _subscription?.Dispose();
        if (_updateHandler is not null)
        {
            updateService.UnregisterFunction(_updateHandler);
        }
    }

    private async Task LoadCoursesAsync(bool forceLoad)
    {
        if (ApplicationState.TryTakeFromJson<IEnumerable<CourseCln>>(nameof(AvailableCourses), out var cached))
        {
            AvailableCourses = cached?.ToList() ?? new();
        }
        if(forceLoad || AvailableCourses == null || AvailableCourses.Count == 0)
        {
            var tempList = new List<CourseCln>();
            await foreach (var course in AdminService.GetAllCoursesAsync(ReThrowError))
            {
                tempList.Add(course);
            }
            AvailableCourses = tempList;
        }
    }

    private async Task LoadStudentsAsync(bool forceLoad)
    {
        if (ApplicationState.TryTakeFromJson<IEnumerable<StudentCln>>(nameof(AvailableStudents), out var cached))
        {
            AvailableStudents = cached?.ToList() ?? new();
        }
        if (forceLoad || AvailableStudents == null || AvailableStudents.Count == 0)
        {
            var tempList = new List<StudentCln>();
            await foreach (var student in AdminService.GetAllStudentsAsync(ReThrowError))
            {
                tempList.Add(student);
            }
            AvailableStudents = tempList;
        }
    }

    private async Task LoadOrdersAsync(bool forceLoad)
    {
        if (ApplicationState.TryTakeFromJson<IEnumerable<OrderCourseCln>>(nameof(OrderCourseData), out var cached))
        {
            OrderCourseData = cached?.ToList();
        }
        @* if (forceLoad || (OrderCourseData == null || OrderCourseData.Count == 0 || !ApplicationState.TryTakeFromJson<int>(nameof(OrderCourseData), out var _))) *@
        {
            if (OrderCourseData == null)
            {
                OrderCourseData = new List<OrderCourseCln>();
            }

            int currentPage = OrderCourseGrid is null ? 0 : OrderCourseGrid.CurrentPage;
            int rowsPerPage = OrderCourseGrid is null ? 10 : OrderCourseGrid.RowsPerPage;

            await ((IInteractiveGrid)this).ReloadDataAsync(AdminService.GetAllOrderCourseAsync(ReThrowError, FillOrderCourseExtended.Student | FillOrderCourseExtended.Course), OrderCourseData, currentPage, rowsPerPage);

            @* OrderCourseData = new();
            _ = InvokeAsync(StateHasChanged);

            var orderCoursesStream = AdminService.GetAllOrderCourseAsync(ReThrowError, FillOrderCourseExtended.Student | FillOrderCourseExtended.Course);
            
            if (orderCoursesStream != null)
            {
                await foreach (var item in orderCoursesStream)
                {
                    if (RendererInfo.Name == "WebAssembly")
                    {
                        OrderCourseData.Add(item);
                        var maxIndex = OrderCourseGrid.CurrentPage * OrderCourseGrid.RowsPerPage;
                        var minIndex = (OrderCourseGrid.CurrentPage == 0 ? 0 : OrderCourseGrid.CurrentPage - 1) * OrderCourseGrid.RowsPerPage;

                        if ((OrderCourseData.Count <= maxIndex && OrderCourseData.Count >= minIndex) || (OrderCourseGrid.CurrentPage == 0 && OrderCourseData.Count <= OrderCourseGrid.RowsPerPage))
                        {
                            StateHasChanged();
                            await Task.Delay(1);
                        }
                    }
                    else
                    {
                        OrderCourseData.Add(item);
                        _ = InvokeAsync(StateHasChanged);
                    }
                }
            } *@

        }
        StateHasChanged(); 
    }

    private async Task NewItemAsync()
    {
        var options = new DialogOptions { CloseButton = true, CloseOnEscapeKey = true };
        var parameters = new DialogParameters<AddOrderCourseDialog>
        {
            { x => x.AvailableCourses, AvailableCourses },
            { x => x.AvailableStudents, AvailableStudents }
        };
        var dialog = await DialogService.ShowAsync<AddOrderCourseDialog>("Přidat pořadí kurzu", parameters, options);

        var result = await dialog.Result;
        
        if (result != null && !result.Canceled && result.Data is OrderCourseCln orderCourse)
        {
            var newOrderCourse = await AdminService.AddOrderCourseAsync(orderCourse, ReThrowError, FillOrderCourseExtended.Student | FillOrderCourseExtended.Course);
            if (newOrderCourse is not null)
            {
                if (OrderCourseData == null) OrderCourseData = new List<OrderCourseCln>();
                
                OrderCourseData.Insert(0, newOrderCourse);
                StateHasChanged(); 
            }
        }
    }

    private async Task DeleteItemAsync(OrderCourseCln item)
    {
        await AdminService.DeleteOrderCourseAsync(item.Id, ReThrowError);
        @* OrderCourseData?.Remove(item); *@
        @* StateHasChanged();  *@
    }

    private void CommittedItemChanges(OrderCourseCln item)
    {
        _ = CommitDataAsync(item);
    }

    private async Task CommitDataAsync(OrderCourseCln OrderCourse)
    {
        await AdminService.UpdateOrderCourseAsync(OrderCourse, ReThrowError);
    }

    private void ChangeValueCourse(OrderCourseCln item, CourseCln value)
    {
        if (item.Extended == null) return;
        item.Extended.Course = value;
        item.CourseId = value.Id;
        CommittedItemChanges(item);
    }

    private void ChangeValueStudent(OrderCourseCln item, StudentCln value)
    {
        if (item.Extended == null) return;
        item.Extended.Student = value;
        item.StudentId = value.Id;
        CommittedItemChanges(item);
    }

    void IClientUpdateHandler.StateHasChanged()
    {
        StateHasChanged();
    }

    Task IClientUpdateHandler.InvokeAsync(Func<Task> work)
    {
        return InvokeAsync(work);
    }
    void IInteractiveGrid.StateHasChanged()
    {
        StateHasChanged();
    }

    Task IInteractiveGrid.InvokeAsync(Func<Task> work)
    {
        return InvokeAsync(work);
    }

    IAdminService IInteractiveGrid.AdminService => AdminService;
}