@page "/admin/students"
@using System.Runtime.InteropServices
@attribute [Authorize(Roles = "Admin")]
@inject NavigationManager NavigationManager
@inject PersistentComponentState ApplicationState
@inject IAdminService AdminService
@implements IDisposable
@inject IJSRuntime jSRuntime
@inject IUpdateService updateService
@implements IClientUpdateHandler
@implements IInteractiveGrid

@if (StudentsData is null)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="my-6" />
}
else
{
    <MudDataGrid @ref="StudentGrid" T="StudentCln" Items="@StudentsData" ReadOnly="false" EditMode="DataGridEditMode.Cell"
        CommittedItemChanges="@CommittedItemChanges" Bordered="true" Dense="true"
        EditTrigger="DataGridEditTrigger.OnRowClick">
        <ToolBarContent>
            <MudText aria-label="admin-students-table-header" Typo="Typo.h6">Žáci</MudText>
            <MudSpacer />
            <MudButtonGroup Class="ma-0 pa-0" Color="Color.Success" Variant="Variant.Outlined">
                <MudButton aria-label="admin-students-table-btn-add" OnClick="NewItemAsync">Přidat žáka</MudButton>
            </MudButtonGroup>
        </ToolBarContent>
        <Columns>
            <HierarchyColumn Hidden />
            <PropertyColumn aria-label="admin-students-table-value-id" Property="x => x.Id" Title="Id" Editable="false" />
            <PropertyColumn aria-label="admin-students-table-value-name" Property="x => x.Name" />
            <PropertyColumn aria-label="admin-students-table-value-email" Property="x => x.Email" />
            <PropertyColumn aria-label="admin-students-table-value-class" Property="x => x.Class" />
            <TemplateColumn Title="Seznam kurzů">
                <CellTemplate>
                    <MudButton aria-label="admin-students-table-value-list-expand" OnClick="() => ExpandRow(context.Item)"
                        StartIcon="@Icons.Material.Outlined.List" Size="Size.Small">Seznam kurzů</MudButton>
                </CellTemplate>
                <EditTemplate>
                    <MudButton aria-label="admin-students-table-value-list-expand" OnClick="() => ExpandRow(context.Item)"
                        StartIcon="@Icons.Material.Outlined.List" Size="Size.Small">Seznam kurzů</MudButton>
                </EditTemplate>
            </TemplateColumn>
            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton aria-label="admin-students-table-value-delete" Size="Size.Small"
                        Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => DeleteItemAsync(context.Item))" />
                </CellTemplate>
                <EditTemplate>
                    <MudIconButton aria-label="admin-students-table-value-delete" Size="Size.Small"
                        Icon="@Icons.Material.Outlined.Delete" OnClick="@(() => DeleteItemAsync(context.Item))" />
                </EditTemplate>
            </TemplateColumn>
        </Columns>
        <ChildRowContent>
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText aria-label="admin-students-table-value-lst-header" Typo="Typo.h6">Seznam kurzů -
                            @context.Item.Name</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (context.Item?.Extended?.Courses != null)
                    {
                        <MudDataGrid T="CourseCln" Items="context.Item.Extended.Courses" ReadOnly="true" Bordered="true"
                            Dense="true">
                            <Columns>
                                <PropertyColumn aria-label="admin-students-table-value-lst-value-id" Property="x => x.Id"
                                    Title="Id" />
                                <PropertyColumn aria-label="admin-students-table-value-lst-value-name" Property="x => x.Name"
                                    Title="Jméno" />
                                <PropertyColumn aria-label="admin-students-table-value-lst-value-desc"
                                    Property="x => x.Description" Title="Popis" />
                                <TemplateColumn Title="Pořadí" Editable="false">
                                    <CellTemplate Context="course">
                                        <MudText aria-label="admin-students-table-value-lst-value-poradi">
                                            @string.Join(", ", context.Item.Extended?.OrderCourses?.Where(oc => oc.CourseId ==
                                            course.Item.Id).Select(oc => oc.Order) ?? [])
                                </MudText>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
                                }
                    else
                    {
                        <MudText>Error - extended je null</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </ChildRowContent>
        <PagerContent>
            <MudDataGridPager T="StudentCln" />
        </PagerContent>
    </MudDataGrid>

    <MudButtonGroup Color="Color.Info" Variant="Variant.Outlined">
        <MudFileUpload T="IBrowserFile" Accept=".csv" FilesChanged="UploadCsv" MaximumFileCount="100">
            <ActivatorContent>
                <MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.CloudUpload">
                    Nahrát csv
                </MudButton>
            </ActivatorContent>
        </MudFileUpload>
        <MudMenu Icon="@Icons.Material.Filled.ArrowDropDown" Style="align-self: auto;">
            <MudMenuItem OnClick="DownloadCsv">Stáhnout vzorové csv</MudMenuItem>
        </MudMenu>
    </MudButtonGroup>
}

@code {
    private List<StudentCln>? StudentsData;
    private MudDataGrid<StudentCln> StudentGrid = default!;
    private PersistingComponentStateSubscription? _subscription;
    private EventHandler<TpvUpdateEventArgs>? _updateHandler;
    [CascadingParameter]
    public bool ReThrowError { get; set; }


    protected override void OnInitialized()
    {
        _subscription = ApplicationState.RegisterOnPersisting(Persist);
        _ = LoadData(true);

        _updateHandler = ((IClientUpdateHandler)this).FactoryUpdateHandler(
            [TableNames.Students, TableNames.OrderCourses, TableNames.Courses],
            LoadData
        );

        if (_updateHandler is not null)
        {
            updateService.RegisterFunction(_updateHandler);
        }
    }

    private async Task LoadData(bool forceLoad = false)
    {
        await LoadStudentsAsync(forceLoad);
        StateHasChanged();
    }

    private async Task LoadStudentsAsync(bool forceLoad)
    {
        if (ApplicationState.TryTakeFromJson<IEnumerable<StudentCln>>(nameof(StudentsData), out var cached))
        {
            StudentsData = cached?.ToList();
        }
        if (forceLoad || (StudentsData == null || StudentsData.Count == 0 || !ApplicationState.TryTakeFromJson<int>(nameof(StudentsData), out var _)))
        {
            if (StudentsData == null)
            {
                StudentsData = new List<StudentCln>();
            }

            int currentPage = StudentGrid is null ? 0 : StudentGrid.CurrentPage;
            int rowsPerPage = StudentGrid is null ? 10 : StudentGrid.RowsPerPage;

            await ((IInteractiveGrid)this).ReloadDataAsync(AdminService.GetAllStudentsAsync(ReThrowError, FillStudentExtended.Courses | FillStudentExtended.OrderCourses), StudentsData, currentPage, rowsPerPage);

            @* _ = InvokeAsync(StateHasChanged);

            await foreach (var student in AdminService.GetAllStudentsAsync(ReThrowError, FillStudentExtended.Courses |
            FillStudentExtended.OrderCourses))
            {
                if (RendererInfo.Name == "WebAssembly")
                {
                    StudentsData.Add(student);
                    var maxIndex = StudentGrid.CurrentPage * StudentGrid.RowsPerPage;
                    var minIndex = (StudentGrid.CurrentPage == 0 ? 0 : StudentGrid.CurrentPage - 1) * StudentGrid.RowsPerPage;

                    if ((StudentsData.Count <= maxIndex && StudentsData.Count >= minIndex) || (StudentGrid.CurrentPage == 0 &&
                    StudentsData.Count <= StudentGrid.RowsPerPage))
                    {
                        StateHasChanged();
                        await Task.Delay(1);
                    }
                }
                else
                {
                    StudentsData.Add(student);
                    _ = InvokeAsync(StateHasChanged);
                }
            } *@
        }
    }

    private Task Persist()
    {
        if (StudentsData is not null)
            ApplicationState.PersistAsJson(nameof(StudentsData), StudentsData);

        return Task.CompletedTask;
    }

    public void Dispose() 
    {
        _subscription?.Dispose();
        if (_updateHandler is not null)
        {
            updateService.UnregisterFunction(_updateHandler);
        }
    }

    private async Task NewItemAsync()
    {
        var newStudent = await AdminService.AddStudentAsync(new StudentCln(), ReThrowError, FillStudentExtended.Courses);
        if (newStudent is not null)
        {
            StudentsData?.Insert(0, newStudent);
        }
    }

    private async Task DeleteItemAsync(StudentCln item)
    {
        await AdminService.DeleteStudentAsync(item.Id, ReThrowError);
        StudentsData?.Remove(item);
    }

    private void CommittedItemChanges(StudentCln item)
    {
        _ = CommitDataAsync(item);
    }

    private async Task CommitDataAsync(StudentCln Student)
    {
        await AdminService.UpdateStudentAsync(Student, ReThrowError);
    }

    private void ExpandRow(StudentCln item)
    {
        _ = StudentGrid.ToggleHierarchyVisibilityAsync(item);
    }

    private async Task UploadCsv(IBrowserFile file)
    {
        var students = new List<StudentCln>();
        using var stream = file.OpenReadStream();
        using var reader = new StreamReader(stream);

        bool isHeader = true;

        var line = string.Empty;
        while ((line = await reader.ReadLineAsync()) != null)
        {
            if (string.IsNullOrWhiteSpace(line))
            {
                continue;
            }

            if (isHeader)
            {
                isHeader = false;
                continue;
            }

            var columns = line.Split(";");

            if (columns.Length != 3)
            {
                continue;
            }

            students.Add(new StudentCln
            {
                Name = columns[0].Trim(),
                Class = columns[1].Trim().Replace("-", ";"),
                Email = columns[2].Trim(),
            });
        }

        foreach (var student in students)
        {
            var newStud = AdminService.AddStudentAsync(student, ReThrowError);
        }

        await LoadData();
        StateHasChanged();
        _ = InvokeAsync(StateHasChanged);
        Thread.Sleep(1);
    }

    private async Task DownloadCsv()
    {
        await jSRuntime.InvokeVoidAsync("downloadFile", "Example-Students.csv");
    }

    void IClientUpdateHandler.StateHasChanged()
    {
        StateHasChanged();
    }

    Task IClientUpdateHandler.InvokeAsync(Func<Task> work)
    {
        return InvokeAsync(work);
    }

    void IInteractiveGrid.StateHasChanged()
    {
        StateHasChanged();
    }

    Task IInteractiveGrid.InvokeAsync(Func<Task> work)
    {
        return InvokeAsync(work);
    }

    IAdminService IInteractiveGrid.AdminService => AdminService;
}